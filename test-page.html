<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API录制测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .loading {
            display: none;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <h1>Chrome扩展API录制功能测试</h1>
    
    <div class="test-section">
        <h2>📡 HTTP请求测试</h2>
        <p>点击下面的按钮发送不同类型的HTTP请求，测试API录制功能：</p>
        
        <button onclick="testGETRequest()">GET请求测试</button>
        <button onclick="testPOSTRequest()">POST请求测试</button>
        <button onclick="testPUTRequest()">PUT请求测试</button>
        <button onclick="testDELETERequest()">DELETE请求测试</button>
        <button onclick="testJSONPRequest()">JSONP请求测试</button>
        
        <div class="loading" id="loading">发送请求中...</div>
        <div class="results" id="results">点击按钮开始测试...</div>
    </div>
    
    <div class="test-section">
        <h2>🔄 批量请求测试</h2>
        <p>测试大量并发请求的录制能力：</p>
        
        <button onclick="testBatchRequests()">发送10个并发请求</button>
        <button onclick="testSequentialRequests()">发送5个顺序请求</button>
        <button onclick="testMixedRequests()">混合请求类型测试</button>
    </div>
    
    <div class="test-section">
        <h2>🎯 特殊场景测试</h2>
        <p>测试特殊情况下的请求录制：</p>
        
        <button onclick="testCORSRequest()">跨域请求测试</button>
        <button onclick="testErrorRequest()">错误请求测试</button>
        <button onclick="testLargePayload()">大数据载荷测试</button>
        <button onclick="testFileUpload()">文件上传模拟</button>
    </div>
    
    <div class="test-section">
        <h2>🛠️ 扩展控制</h2>
        <p>测试扩展的控制功能：</p>
        
        <button onclick="startRecording()">开始录制</button>
        <button onclick="stopRecording()">停止录制</button>
        <button onclick="getState()">获取状态</button>
        <button onclick="clearRecords()">清空记录</button>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        
        function showLoading() {
            loadingDiv.style.display = 'block';
        }
        
        function hideLoading() {
            loadingDiv.style.display = 'none';
        }
        
        function appendResult(message) {
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
        }
        
        function clearResults() {
            resultsDiv.textContent = '';
        }
        
        // 基础API请求测试
        async function testGETRequest() {
            showLoading();
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
                const data = await response.json();
                appendResult(`GET请求成功: ${response.status} - ${data.title}`);
            } catch (error) {
                appendResult(`GET请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testPOSTRequest() {
            showLoading();
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token-123'
                    },
                    body: JSON.stringify({
                        title: 'API录制测试',
                        body: '这是一个测试POST请求',
                        userId: 1
                    })
                });
                const data = await response.json();
                appendResult(`POST请求成功: ${response.status} - ID: ${data.id}`);
            } catch (error) {
                appendResult(`POST请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testPUTRequest() {
            showLoading();
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: 1,
                        title: '更新的标题',
                        body: '更新的内容',
                        userId: 1
                    })
                });
                const data = await response.json();
                appendResult(`PUT请求成功: ${response.status} - ${data.title}`);
            } catch (error) {
                appendResult(`PUT请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testDELETERequest() {
            showLoading();
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1', {
                    method: 'DELETE'
                });
                appendResult(`DELETE请求成功: ${response.status}`);
            } catch (error) {
                appendResult(`DELETE请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        function testJSONPRequest() {
            showLoading();
            const script = document.createElement('script');
            script.src = 'https://api.github.com/users/octocat?callback=handleJSONP';
            
            window.handleJSONP = function(data) {
                appendResult(`JSONP请求成功: ${data.data.login} - ${data.data.public_repos} 个仓库`);
                document.head.removeChild(script);
                delete window.handleJSONP;
                hideLoading();
            };
            
            script.onerror = function() {
                appendResult('JSONP请求失败');
                hideLoading();
            };
            
            document.head.appendChild(script);
        }
        
        // 批量请求测试
        async function testBatchRequests() {
            showLoading();
            appendResult('开始发送10个并发请求...');
            
            const promises = [];
            for (let i = 1; i <= 10; i++) {
                promises.push(
                    fetch(`https://jsonplaceholder.typicode.com/posts/${i}`)
                        .then(response => response.json())
                );
            }
            
            try {
                const results = await Promise.all(promises);
                appendResult(`并发请求完成: 成功获取 ${results.length} 个响应`);
            } catch (error) {
                appendResult(`并发请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testSequentialRequests() {
            showLoading();
            appendResult('开始发送5个顺序请求...');
            
            try {
                for (let i = 1; i <= 5; i++) {
                    const response = await fetch(`https://jsonplaceholder.typicode.com/posts/${i}`);
                    const data = await response.json();
                    appendResult(`顺序请求 ${i}/5: ${data.title}`);
                    await new Promise(resolve => setTimeout(resolve, 500)); // 延迟500ms
                }
                appendResult('顺序请求全部完成');
            } catch (error) {
                appendResult(`顺序请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testMixedRequests() {
            showLoading();
            appendResult('开始混合请求类型测试...');
            
            try {
                // GET
                await fetch('https://jsonplaceholder.typicode.com/posts/1');
                appendResult('混合测试: GET请求完成');
                
                // POST
                await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'Test', body: 'Test body' })
                });
                appendResult('混合测试: POST请求完成');
                
                // PUT
                await fetch('https://jsonplaceholder.typicode.com/posts/1', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: 1, title: 'Updated' })
                });
                appendResult('混合测试: PUT请求完成');
                
                appendResult('混合请求测试全部完成');
            } catch (error) {
                appendResult(`混合请求测试失败: ${error.message}`);
            }
            hideLoading();
        }
        
        // 特殊场景测试
        async function testCORSRequest() {
            showLoading();
            try {
                // 尝试一个可能触发CORS的请求
                const response = await fetch('https://api.github.com/repos/microsoft/vscode', {
                    headers: {
                        'X-Custom-Header': 'test'
                    }
                });
                const data = await response.json();
                appendResult(`CORS请求成功: ${data.name} - ${data.stargazers_count} stars`);
            } catch (error) {
                appendResult(`CORS请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testErrorRequest() {
            showLoading();
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/999999');
                appendResult(`错误请求响应: ${response.status} ${response.statusText}`);
            } catch (error) {
                appendResult(`错误请求异常: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testLargePayload() {
            showLoading();
            try {
                // 创建一个大的数据载荷
                const largeData = {
                    title: 'Large Payload Test',
                    content: 'x'.repeat(10000), // 10KB的数据
                    metadata: {
                        timestamp: Date.now(),
                        version: '1.0.0',
                        tags: Array.from({length: 100}, (_, i) => `tag-${i}`)
                    }
                };
                
                const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(largeData)
                });
                
                appendResult(`大载荷请求完成: ${response.status} - 数据大小: ${JSON.stringify(largeData).length} 字节`);
            } catch (error) {
                appendResult(`大载荷请求失败: ${error.message}`);
            }
            hideLoading();
        }
        
        async function testFileUpload() {
            showLoading();
            try {
                // 模拟文件上传
                const formData = new FormData();
                formData.append('file', new Blob(['这是一个测试文件内容'], {type: 'text/plain'}), 'test.txt');
                formData.append('description', '测试文件上传');
                
                const response = await fetch('https://httpbin.org/post', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                appendResult(`文件上传模拟成功: ${response.status} - 表单字段: ${Object.keys(data.form || {}).length}`);
            } catch (error) {
                appendResult(`文件上传模拟失败: ${error.message}`);
            }
            hideLoading();
        }
        
        // 扩展控制功能
        async function startRecording() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({ type: 'START_RECORDING' });
                    appendResult(`开始录制: ${response.success ? '成功' : '失败'}`);
                } else {
                    appendResult('开始录制: 未检测到Chrome扩展环境');
                }
            } catch (error) {
                appendResult(`开始录制失败: ${error.message}`);
            }
        }
        
        async function stopRecording() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({ type: 'STOP_RECORDING' });
                    appendResult(`停止录制: ${response.success ? '成功' : '失败'}`);
                } else {
                    appendResult('停止录制: 未检测到Chrome扩展环境');
                }
            } catch (error) {
                appendResult(`停止录制失败: ${error.message}`);
            }
        }
        
        async function getState() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({ type: 'GET_STATE' });
                    if (response.success) {
                        const state = response.state;
                        appendResult(`录制状态: ${state.isRecording ? '录制中' : '未录制'} - 记录数: ${state.recordCount}`);
                    } else {
                        appendResult('获取状态失败');
                    }
                } else {
                    appendResult('获取状态: 未检测到Chrome扩展环境');
                }
            } catch (error) {
                appendResult(`获取状态失败: ${error.message}`);
            }
        }
        
        async function clearRecords() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({ type: 'CLEAR_RECORDS' });
                    appendResult(`清空记录: ${response.success ? '成功' : '失败'}`);
                } else {
                    appendResult('清空记录: 未检测到Chrome扩展环境');
                }
            } catch (error) {
                appendResult(`清空记录失败: ${error.message}`);
            }
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            appendResult('测试页面加载完成');
            
            // 检查扩展环境
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                appendResult('检测到Chrome扩展环境 ✓');
                getState(); // 自动获取初始状态
            } else {
                appendResult('未检测到Chrome扩展环境 - 请确保扩展已安装并启用');
            }
        });
    </script>
</body>
</html>